# Issue #43: モバイルブラウザに習慣継続のための通知を送りたい

## 基本情報

- **Issue番号**: #43
- **作成日**: 2025-01-07
- **担当**: @me
- **ステータス**: 計画中
- **優先度**: High
- **GitHub Issue**: <https://github.com/code-application/accustomed/issues/43>

## 要求分析

### ユーザーストーリー

```
習慣トラッカーのユーザー として
週に1回必ずアプリを開いて習慣を継続する ために
モバイルブラウザに3日に1回程度、具体的なタスク内容を含む通知を夕方に受け取る ことで習慣継続を促されたい
```

### 受け入れ条件

#### 機能要件

- **シナリオ 1**: 通知許可の取得
  - **Given**: 初回アクセス時またはユーザーが設定画面を開いた時
  - **When**: 通知許可を求めるダイアログが表示された時
  - **Then**: ユーザーが許可/拒否を選択できる

- **シナリオ 2**: 定期通知の送信
  - **Given**: 通知許可が得られ、ユーザーがタスクを設定している状態
  - **When**: 前回のアプリアクセスから3日経過し、夕方18時になった時
  - **Then**: ユーザーのタスク内容を含む具体的な通知がモバイルブラウザに送信される

- **シナリオ 3**: 前回と異なる通知文言の選択
  - **Given**: 過去に通知を送信している状態
  - **When**: 新しい通知を送信する時
  - **Then**: 前回送信した通知と異なる文言パターンが選択される

- **シナリオ 4**: 通知のON/OFF設定
  - **Given**: ユーザーが設定画面を開いている状態
  - **When**: 通知設定のトグルスイッチを操作した時
  - **Then**: 通知のON/OFFが切り替わる

### 通知メッセージのバリエーション

- 「今日も[タスク名]をしましょう」（例：「今日も読書をしましょう」）
- 「[タスク名]の時間です」（例：「筋トレの時間です」）
- 「[タスク名]を続けて理想の自分に近づきましょう」
- 「記録を忘れていませんか？[タスク名]の実績を更新しましょう」
- 「今週の[タスク名]の進捗はいかがですか？」

### 非機能要件

- **パフォーマンス**: 通知送信処理が500ms以内で完了すること
- **プライバシー**:
  - ユーザーが設定したタスク名は通知に含める（例：読書、筋トレ）
  - ただし、個人的な詳細情報（具体的な目標数値、頻度設定など）は通知に含めない
- **互換性**: 主要なモバイルブラウザ（Safari、Chrome）で動作
- **スケジューリング**: 毎日夕方18時に通知判定処理を実行

## 技術調査

### 現状分析

#### プロジェクト構造

- **アーキテクチャ**: レイヤードアーキテクチャ採用済み
- **データ管理**: LocalStorage + リポジトリパターン（部分実装）
- **UI**: shadcn/ui + React Hooks
- **既存通知**: Toast システム実装済み

#### 既存データ構造

```typescript
interface TaskConfiguration {
  content: string;
  frequency: TaskFrequency;
  period: TaskPeriod;
  createdAt: Date;
  // 拡張が必要: notificationSettings?
}
```

### 実装方針

#### 技術選択

1. **通知方式**: 段階的アプローチ
   - Phase 1: Notification API（基本通知）
   - Phase 2: Service Worker + Web Push API
   - Phase 3: サーバーサイドスケジューリング

2. **ブラウザ対応**:
   - **Chrome Android**: フルサポート（優先実装）
   - **Safari iOS**: PWA必須の制約あり（段階的対応）

3. **データ拡張**:
   - `TaskConfiguration`に通知設定を追加
   - LocalStorageの既存データ互換性を保持

#### アーキテクチャ影響

- **Domain層**: 通知ドメインサービスの追加
- **Application層**: 通知アプリケーションサービスの追加
- **Infrastructure層**: ブラウザ通知実装の追加
- **Presentation層**: 通知設定UIコンポーネントの追加

### リスクと制約

#### 技術的リスク

- **Safari iOS制約**: PWAインストール必須
- **ブラウザ互換性**: 各ブラウザの通知API差異
- **パフォーマンス**: 3日間隔チェックの効率化

#### 制約条件

- **セキュリティ**: VAPID鍵管理（Phase 2以降）
- **ユーザビリティ**: 段階的な許可リクエスト
- **データ移行**: 既存LocalStorageデータの保持

## 工数見積もり

### Story Points

- **合計**: 13 SP
- **根拠**: 通知機能は新領域で技術調査が必要、3段階実装で複雑度中〜高

### Phase別工数

- **Phase 1**: 5 SP (基本通知機能、データ拡張、UI追加)
- **Phase 2**: 5 SP (Service Worker、Web Push API統合)
- **Phase 3**: 3 SP (サーバーサイドスケジューリング)

### 不確実性要素

- **高リスク要素**: Safari iOS PWA制約、ブラウザ間API差異
- **依存関係**: Web Push APIキー取得、Vercel Cron Functions設定

## テスト計画

### テスト戦略

#### テスト階層

- **Unit Tests** (70%): 通知ロジック、権限管理、メッセージ生成
- **Integration Tests** (20%): LocalStorage統合、UI連携
- **E2E Tests** (10%): 通知許可フロー、実際の通知送信

#### テストアプローチ

- **テスト駆動開発**: No (探索的実装のため)
- **BDD**: Yes (受け入れ条件がGiven/When/Then形式)
- **自動化レベル**: Unit/Integration自動化、E2Eは手動+自動

### テストケース

#### Unit Test Cases

- [ ] **UC1**: 通知許可状態の管理
  - **Given**: ブラウザが通知APIをサポートしている
  - **When**: 許可状態を確認する
  - **Then**: 正しい許可状態（granted/denied/default）を返す

- [ ] **UC2**: 3日間隔チェック機能
  - **Given**: 最後のアクセス日時が記録されている
  - **When**: 現在時刻と比較する
  - **Then**: 3日経過の判定が正しく行われる

- [ ] **UC3**: 通知メッセージ生成
  - **Given**: タスク名と前回通知文言が与えられている
  - **When**: 新しい通知メッセージを生成する
  - **Then**: 前回と異なる文言が選択される

#### Integration Test Cases

- [ ] **IC1**: 通知設定のLocalStorage保存
  - **Given**: ユーザーが通知設定を変更した
  - **When**: 設定を保存する
  - **Then**: LocalStorageに正しく保存される

- [ ] **IC2**: タスクデータと通知設定の連携
  - **Given**: タスクに通知設定が追加されている
  - **When**: タスク一覧を表示する
  - **Then**: 通知設定が正しく表示される

#### E2E Test Cases

- [ ] **E2E1**: 通知許可フロー（Chrome Android）
  - **Given**: 初回アクセスのユーザー
  - **When**: 通知設定画面を開き許可をリクエストする
  - **Then**: ブラウザの許可ダイアログが表示され、許可後に設定が有効になる

- [ ] **E2E2**: 実際の通知送信（Phase 1）
  - **Given**: 通知が許可され、3日経過している
  - **When**: 手動で通知チェック機能を実行する
  - **Then**: ブラウザ通知が表示される

### テスト環境

#### 必要な環境

- **開発環境**: ローカル開発サーバー（https必須）
- **テスト環境**: Chrome Android、Safari iOS（PWA）
- **CI/CD**: GitHub Actions（unit/integration自動実行）

#### テストデータ

- **テストデータ作成**: モックタスクデータ、日時操作用データ
- **データクリーンアップ**: LocalStorageクリア、通知許可リセット

### テストツール

#### 使用予定ツール

- **Unit Testing**: Jest + React Testing Library
- **Integration Testing**: Jest + LocalStorage Mock
- **E2E Testing**: 手動テスト + Playwright（Phase 2以降）
- **テストレポート**: Jest Coverage Report

#### エントリー/エグジット基準

##### Unit Test

- **エントリー**: コンポーネント・フック実装完了
- **エグジット**: カバレッジ80%以上、全テスト通過

##### Integration Test

- **エントリー**: LocalStorage統合実装完了
- **エグジット**: データ整合性確認、全シナリオ通過

##### E2E Test

- **エントリー**: UI実装完了、テスト環境準備完了
- **エグジット**: 主要ブラウザでの動作確認完了

## 実装計画

### Phase 1: 基本通知機能（即座に実装可能）

- [ ] **データ構造拡張**
  - `TaskConfiguration`に`notificationEnabled: boolean`追加
  - LocalStorage互換性確認
  
- [ ] **通知許可管理**
  - `useNotificationPermission`フック作成
  - 許可リクエストフロー実装
  
- [ ] **基本通知実装**
  - Notification API使用の基本通知
  - 3日間隔チェック機能（ローカル実行）
  - 通知メッセージバリエーション実装
  
- [ ] **設定UI追加**
  - 通知ON/OFFトグルコンポーネント
  - 設定画面への組み込み

### Phase 2: Service Worker実装（中期）

- [ ] **Service Worker基盤**
  - `public/sw.js`作成
  - `public/manifest.json`作成
  - Service Worker登録コード
  
- [ ] **Web Push API統合**
  - VAPID鍵設定
  - サブスクリプション管理
  - プッシュ通知Context作成

### Phase 3: サーバーサイドスケジューリング（長期）

- [ ] **API Routes追加**
  - `/api/notifications/subscribe`
  - `/api/notifications/send`
  - `/api/notifications/schedule`
  
- [ ] **Cron機能**
  - Vercel Cron Functions
  - 3日間隔の自動通知送信

## 完了の定義

### プロジェクト共通DoD

- [ ] すべての受け入れ条件を満たしている
- [ ] コードレビューが完了している
- [ ] 単体テスト・統合テスト・E2Eテストがすべて通っている
- [ ] ドキュメントが更新されている
- [ ] パイプラインがすべてPASSしている
- [ ] セキュリティチェックが完了している
- [ ] パフォーマンステストが完了している

### Issue固有DoD

- [ ] Chrome AndroidとSafari iOS（PWA）での動作確認完了
- [ ] 通知許可フローがユーザビリティテスト完了
- [ ] 3日間隔の通知タイミングが正確に動作
- [ ] 通知メッセージのバリエーション全パターン確認完了
- [ ] LocalStorageデータの下位互換性確認完了

## 実装ログ

### 2025-01-07

- Issue #43にアサイン
- 現状調査と技術調査を完了
- 実装方針決定（段階的アプローチ）
- バックログドキュメント作成完了

## フィードバック（手動追記用）

### 実装中のフィードバック
<!-- ここに手動でフィードバックを追記してください -->

### テスト結果と品質評価
<!-- テスト結果の評価と改善点を追記してください -->

### 完了後の振り返り
<!-- 完了後の振り返りを追記してください -->

### 今後の改善提案
<!-- 今後の類似機能開発への提言を追記してください -->

## 関連リンク

- **GitHub Issue**: <https://github.com/code-application/accustomed/issues/43>
- **アーキテクチャ設計書**: ../ARCHITECTURE.md
- **ドメインモデル**: ../models/domain-models.md
